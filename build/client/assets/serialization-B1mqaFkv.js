import{k,l as R,m as V,n as Q,s as J,o as Z,p as z,q as O,t as P,u as _,v as H,w as Y,x as m,y as $,D as ee}from"./docs-layout-Ce5CccAJ.js";function xe(e,t){return e.documentsStore.get(e.data.docs,t)}function te(e){return e.documentsStore.count(e.data.docs)}const M="fulltext",ne="hybrid",oe="vector";function se(e,t){return e[1]-t[1]}function ce(e,t){return t[1]-e[1]}function re(e="desc"){return e.toLowerCase()==="asc"?se:ce}function B(e,t,s){const n={},f=t.map(([d])=>d),u=e.documentsStore.getMultiple(e.data.docs,f),p=Object.keys(s),o=e.index.getSearchablePropertiesWithTypes(e.data.index);for(const d of p){let y;if(o[d]==="number"){const{ranges:r}=s[d],g=r.length,h=Array.from({length:g});for(let i=0;i<g;i++){const S=r[i];h[i]=[`${S.from}-${S.to}`,0]}y=Object.fromEntries(h)}n[d]={count:0,values:y??{}}}const b=u.length;for(let d=0;d<b;d++){const y=u[d];for(const r of p){const g=r.includes(".")?k(y,r):y[r],h=o[r],i=n[r].values;switch(h){case"number":{const S=s[r].ranges;j(S,i)(g);break}case"number[]":{const S=new Set,l=s[r].ranges,c=j(l,i,S);for(const a of g)c(a);break}case"boolean":case"enum":case"string":{C(i,h)(g);break}case"boolean[]":case"enum[]":case"string[]":{const c=C(i,h==="boolean[]"?"boolean":"string",new Set);for(const a of g)c(a);break}default:throw R("FACET_NOT_SUPPORTED",h)}}}for(const d of p){const y=n[d];if(y.count=Object.keys(y.values).length,o[d]==="string"){const r=s[d],g=re(r.sort);y.values=Object.fromEntries(Object.entries(y.values).sort(g).slice(r.offset??0,r.limit??10))}}return n}function j(e,t,s){return n=>{for(const f of e){const u=`${f.from}-${f.to}`;s?.has(u)||n>=f.from&&n<=f.to&&(t[u]===void 0?t[u]=1:(t[u]++,s?.add(u)))}}}function C(e,t,s){const n=t==="boolean"?"false":"";return f=>{const u=f?.toString()??n;s?.has(u)||(e[u]=(e[u]??0)+1,s?.add(u))}}const ie={reducer:(e,t,s,n)=>(t[n]=s,t),getInitialValue:e=>Array.from({length:e})},W=["string","number","boolean"];function L(e,t,s){const n=s.properties,f=n.length,u=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let c=0;c<f;c++){const a=n[c];if(typeof u[a]>"u")throw R("UNKNOWN_GROUP_BY_PROPERTY",a);if(!W.includes(u[a]))throw R("INVALID_GROUP_BY_PROPERTY",a,W.join(", "),u[a])}const p=t.map(([c])=>V(e.internalDocumentIDStore,c)),o=e.documentsStore.getMultiple(e.data.docs,p),b=o.length,d=s.maxResult||Number.MAX_SAFE_INTEGER,y=[],r={};for(let c=0;c<f;c++){const a=n[c],I={property:a,perValue:{}},D=new Set;for(let x=0;x<b;x++){const v=o[x],T=k(v,a);if(typeof T>"u")continue;const E=typeof T!="boolean"?T:""+T,w=I.perValue[E]??{indexes:[],count:0};w.count>=d||(w.indexes.push(x),w.count++,I.perValue[E]=w,D.add(T))}y.push(Array.from(D)),r[a]=I}const g=G(y),h=g.length,i=[];for(let c=0;c<h;c++){const a=g[c],I=a.length,D={values:[],indexes:[]},x=[];for(let v=0;v<I;v++){const T=a[v],E=n[v];x.push(r[E].perValue[typeof T!="boolean"?T:""+T].indexes),D.values.push(T)}D.indexes=Q(x).sort((v,T)=>v-T),D.indexes.length!==0&&i.push(D)}const S=i.length,l=Array.from({length:S});for(let c=0;c<S;c++){const a=i[c],I=s.reduce||ie,D=a.indexes.map(E=>({id:p[E],score:t[E][1],document:o[E]})),x=I.reducer.bind(null,a.values),v=I.getInitialValue(a.indexes.length),T=D.reduce(x,v);l[c]={values:a.values,result:T}}return l}function G(e,t=0){if(t+1===e.length)return e[t].map(u=>[u]);const s=e[t],n=G(e,t+1),f=[];for(const u of s)for(const p of n){const o=[u];J(o,p),f.push(o)}return f}function F(e,t,s,n){const f=Z(t,n);if(f.length===0)return s;const u=f.flatMap(l=>l.consequence.promote);u.sort((l,c)=>l.position-c.position);const p=new Set,o=new Map,b=new Set;for(const l of u){const c=z(e.internalDocumentIDStore,l.doc_id);if(c!==void 0){if(o.has(c)){const a=o.get(c);l.position<a&&o.set(c,l.position);continue}b.has(l.position)||(p.add(c),o.set(c,l.position),b.add(l.position))}}if(o.size===0)return s;const d=s.filter(([l])=>!p.has(l)),y=1e6,r=[];for(const[l,c]of o.entries())s.find(([I])=>I===l)?r.push([l,y-c]):e.documentsStore.get(e.data.docs,l)&&r.push([l,0]);r.sort((l,c)=>{const a=o.get(l[0])??1/0,I=o.get(c[0])??1/0;return a-I});const g=[],h=new Map;for(const l of r){const c=o.get(l[0]);h.set(c,l)}let i=0,S=0;for(;S<d.length+r.length;)if(h.has(S))g.push(h.get(S)),S++;else if(i<d.length)g.push(d[i]),i++,S++;else break;for(const[l,c]of h.entries())l>=g.length&&g.push(c);return g}function K(e,t,s){const{term:n,properties:f}=t,u=e.data.index;let p=e.caches.propertiesToSearch;if(!p){const r=e.index.getSearchablePropertiesWithTypes(u);p=e.index.getSearchableProperties(u),p=p.filter(g=>r[g].startsWith("string")),e.caches.propertiesToSearch=p}if(f&&f!=="*"){for(const r of f)if(!p.includes(r))throw R("UNKNOWN_INDEX",r,p.join(", "));p=p.filter(r=>f.includes(r))}const o=Object.keys(t.where??{}).length>0;let b;o&&(b=e.index.searchByWhereClause(u,e.tokenizer,t.where,s));let d;const y=t.threshold!==void 0&&t.threshold!==null?t.threshold:1;if(n||f){const r=te(e);if(d=e.index.search(u,n||"",e.tokenizer,s,p,t.exact||!1,t.tolerance||0,t.boost||{},de(t.relevance),r,b,y),t.exact&&n){const g=n.trim().split(/\s+/);d=d.filter(([h])=>{const i=e.documentsStore.get(e.data.docs,h);if(!i)return!1;for(const S of p){const l=ue(i,S);if(typeof l=="string"&&g.every(a=>new RegExp(`\\b${le(a)}\\b`).test(l)))return!0}return!1})}}else if(o){const r=m(u,t.where);r?d=r:d=(b?Array.from(b):[]).map(h=>[+h,0])}else d=Object.keys(e.documentsStore.getAll(e.data.docs)).map(g=>[+g,0]);return d}function le(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ue(e,t){const s=t.split(".");let n=e;for(const f of s)if(n&&typeof n=="object"&&f in n)n=n[f];else return;return n}function fe(e,t,s){const n=O();function f(){const o=Object.keys(e.data.index.vectorIndexes),b=t.facets&&Object.keys(t.facets).length>0,{limit:d=10,offset:y=0,distinctOn:r,includeVectors:g=!1}=t,h=t.preflight===!0;let i=K(e,t,s);if(t.sortBy)if(typeof t.sortBy=="function"){const c=i.map(([D])=>D),I=e.documentsStore.getMultiple(e.data.docs,c).map((D,x)=>[i[x][0],i[x][1],D]);I.sort(t.sortBy),i=I.map(([D,x])=>[D,x])}else i=e.sorter.sortBy(e.data.sorting,i,t.sortBy).map(([c,a])=>[z(e.internalDocumentIDStore,c),a]);else i=i.sort(H);i=F(e,e.data.pinning,i,t.term);let S;h||(S=r?Ie(e,i,y,d,r):X(e,i,y,d));const l={elapsed:{formatted:"",raw:0},hits:[],count:i.length};if(typeof S<"u"&&(l.hits=S.filter(Boolean),g||Y(l,o)),b){const c=B(e,i,t.facets);l.facets=c}return t.groupBy&&(l.groups=L(e,i,t.groupBy)),l.elapsed=e.formatElapsedTime(O()-n),l}async function u(){e.beforeSearch&&await P(e.beforeSearch,e,t,s);const o=f();return e.afterSearch&&await _(e.afterSearch,e,t,s,o),o}return e.beforeSearch?.length||e.afterSearch?.length?u():f()}const A={k:1.2,b:.75,d:.5};function de(e){const t=e??{};return t.k=t.k??A.k,t.b=t.b??A.b,t.d=t.d??A.d,t}function q(e,t,s){const n=t.vector;if(n&&(!("value"in n)||!("property"in n)))throw R("INVALID_VECTOR_INPUT",Object.keys(n).join(", "));const f=e.data.index.vectorIndexes[n.property];if(!f)throw R("UNKNOWN_VECTOR_PROPERTY",n.property);const u=f.node.size;if(n?.value.length!==u)throw n?.property===void 0||n?.value.length===void 0?R("INVALID_INPUT_VECTOR","undefined",u,"undefined"):R("INVALID_INPUT_VECTOR",n.property,u,n.value.length);const p=e.data.index;let o;return Object.keys(t.where??{}).length>0&&(o=e.index.searchByWhereClause(p,e.tokenizer,t.where,s)),f.node.find(n.value,t.similarity??ee,o)}function he(e,t,s="english"){const n=O();function f(){let o=q(e,t,s).sort(H);o=F(e,e.data.pinning,o,void 0);let b=[];t.facets&&Object.keys(t.facets).length>0&&(b=B(e,o,t.facets));const y=t.vector.property,r=t.includeVectors??!1,g=t.limit??10,h=t.offset??0,i=Array.from({length:g});for(let a=0;a<g;a++){const I=o[a+h];if(!I)break;const D=e.data.docs.docs[I[0]];if(D){r||(D[y]=null);const x={id:V(e.internalDocumentIDStore,I[0]),score:I[1],document:D};i[a]=x}}let S=[];t.groupBy&&(S=L(e,o,t.groupBy));const c=O()-n;return{count:o.length,hits:i.filter(Boolean),elapsed:{raw:Number(c),formatted:$(c)},...b?{facets:b}:{},...S?{groups:S}:{}}}async function u(){e.beforeSearch&&await P(e.beforeSearch,e,t,s);const o=f();return e.afterSearch&&await _(e.afterSearch,e,t,s,o),o}return e.beforeSearch?.length||e.afterSearch?.length?u():f()}function ge(e,t,s){const n=pe(K(e,t,s)),f=q(e,t,s),u=t.hybridWeights;return ye(n,f,t.term??"",u)}function ae(e,t,s){const n=O();function f(){let o=ge(e,t,s);o=F(e,e.data.pinning,o,t.term);let b;t.facets&&Object.keys(t.facets).length>0&&(b=B(e,o,t.facets));let y;t.groupBy&&(y=L(e,o,t.groupBy));const r=t.offset??0,g=t.limit??10,h=X(e,o,r,g).filter(Boolean),i=O(),S={count:o.length,elapsed:{raw:Number(i-n),formatted:$(i-n)},hits:h,...b?{facets:b}:{},...y?{groups:y}:{}};if(!(t.includeVectors??!1)){const c=Object.keys(e.data.index.vectorIndexes);Y(S,c)}return S}async function u(){e.beforeSearch&&await P(e.beforeSearch,e,t,s);const o=f();return e.afterSearch&&await _(e.afterSearch,e,t,s,o),o}return e.beforeSearch?.length||e.afterSearch?.length?u():f()}function N(e){return e[1]}function pe(e){const t=Math.max.apply(Math,e.map(N));return e.map(([s,n])=>[s,n/t])}function U(e,t){return e/t}function Se(e,t){return(s,n)=>s*e+n*t}function ye(e,t,s,n){const f=Math.max.apply(Math,e.map(N)),u=Math.max.apply(Math,t.map(N)),p=n&&n.text&&n.vector,{text:o,vector:b}=p?n:be(),d=new Map,y=e.length,r=Se(o,b);for(let h=0;h<y;h++){const[i,S]=e[h],l=U(S,f),c=r(l,0);d.set(i,c)}const g=t.length;for(let h=0;h<g;h++){const[i,S]=t[h],l=U(S,u),c=d.get(i)??0;d.set(i,c+r(0,l))}return[...d].sort((h,i)=>i[1]-h[1])}function be(e){return{text:.5,vector:.5}}function Te(e,t,s){const n=t.mode??M;if(n===M)return fe(e,t,s);if(n===oe)return he(e,t);if(n===ne)return ae(e,t);throw R("INVALID_SEARCH_MODE",n)}function Ie(e,t,s,n,f){const u=e.data.docs,p=new Map,o=[],b=new Set,d=t.length;let y=0;for(let r=0;r<d;r++){const g=t[r];if(typeof g>"u")continue;const[h,i]=g;if(b.has(h))continue;const S=e.documentsStore.get(u,h),l=k(S,f);if(!(typeof l>"u"||p.has(l))&&(p.set(l,!0),y++,!(y<=s)&&(o.push({id:V(e.internalDocumentIDStore,h),score:i,document:S}),b.add(h),y>=s+n)))break}return o}function X(e,t,s,n){const f=e.data.docs,u=Array.from({length:n}),p=new Set;for(let o=s;o<n+s;o++){const b=t[o];if(typeof b>"u")break;const[d,y]=b;if(!p.has(d)){const r=e.documentsStore.get(f,d);u[o]={id:V(e.internalDocumentIDStore,d),score:y,document:r},p.add(d)}}return u}function ve(e,t){e.internalDocumentIDStore.load(e,t.internalDocumentIDStore),e.data.index=e.index.load(e.internalDocumentIDStore,t.index),e.data.docs=e.documentsStore.load(e.internalDocumentIDStore,t.docs),e.data.sorting=e.sorter.load(e.internalDocumentIDStore,t.sorting),e.data.pinning=e.pinning.load(e.internalDocumentIDStore,t.pinning),e.tokenizer.language=t.language}export{xe as g,ve as l,Te as s};
